#!/usr/bin/env python3
"""
üöÄ AUTOMA√á√ÉO PRINCIPAL LEROY MERLIN
Executa processamento completo das planilhas Genesys e Salesforce

Este script executa automaticamente:
1. Processamento de dados Genesys (VOZ, TEXTO, GEST√ÉO)
2. Processamento de dados Salesforce (CRIADO, RESOLVIDO, COMENT√ÅRIOS)
3. Relat√≥rio consolidado dos resultados

Uso:
    python main.py                # Executa tudo automaticamente
    python main.py --genesys      # S√≥ Genesys
    python main.py --salesforce   # S√≥ Salesforce
    python main.py --help         # Mostra ajuda
"""

import sys
import os
import argparse
from datetime import datetime

# Adicionar o diret√≥rio src ao path
current_dir = os.path.dirname(os.path.abspath(__file__))
core_dir = os.path.join(os.path.dirname(current_dir), 'core')
sys.path.append(core_dir)

from src.core.google_sheets_base import GoogleSheetsBase
from scripts.gerenciador_planilhas import GerenciadorPlanilhas

# Inicializar gerenciador de configura√ß√µes
gp = GerenciadorPlanilhas()

# Configura√ß√µes das planilhas - AGORA DIN√ÇMICAS
def obter_config_planilhas():
    """Obt√©m configura√ß√µes atualizadas das planilhas"""
    return {
        "genesys": {
            "id": gp.obter_id("genesys_boletim"),
            "nome": "üìä GENESYS",
            "deteccao": {
                "voz_hc": (gp.obter_abas("genesys_boletim").get("voz_hc", "BASE VOZ"), "GENESYS VOZ HC"),
                "texto_hc": (gp.obter_abas("genesys_boletim").get("texto_hc", "BASE TEXTO"), "GENESYS TEXTO HC"), 
                "gestao_n1": (gp.obter_abas("genesys_boletim").get("gestao_n1", "BASE GE COLABORADOR"), "GENESYS GEST√ÉO N1"),
                "gestao": (gp.obter_abas("genesys_boletim").get("gestao_entrega", "BASE GE COLABORADOR"), "GENESYS GEST√ÉO"),
                "fila": (gp.obter_abas("genesys_boletim").get("fila", "BASE VOZ FILA"), "GENESYS FILA")
            }
        },
        "salesforce": {
            "id": gp.obter_id("salesforce_boletim"),
            "nome": "üíº SALESFORCE", 
            "deteccao": {
                "criado": (gp.obter_abas("salesforce_boletim").get("criado", "BASE ATUALIZADA CORRETA - CRIADO"), "SALESFORCE CRIADO"),
                "resolvido": (gp.obter_abas("salesforce_boletim").get("resolvido", "BASE ATUALIZADA CORRETA - RESOLVIDA"), "SALESFORCE RESOLVIDO"),
                "comentario_bko": (gp.obter_abas("salesforce_boletim").get("comentario_bko", "COMENTARIO BKO"), "SALESFORCE COMENT√ÅRIOS"),
                "seller": (gp.obter_abas("salesforce_boletim").get("seller", "DADOS SELLER"), "SALESFORCE SELLER")
            }
        },
        "produtividade": {
            "id": gp.obter_id("produtividade_boletim"),
            "nome": "üìà PRODUTIVIDADE",
            "deteccao": {
                "produtividade": (gp.obter_abas("produtividade_boletim").get("produtividade", "BASE PROD"), "PRODUTIVIDADE VIS√ÉO"),
                "tempo": (gp.obter_abas("produtividade_boletim").get("tempo", "BASE TEMPO"), "PRODUTIVIDADE TEMPO")
            }
        }
    }

# Obter configura√ß√µes din√¢micas
PLANILHAS_CONFIG = obter_config_planilhas()

def detectar_tipo_arquivo(nome_arquivo, sistema):
    """Detecta o tipo do arquivo baseado no sistema (genesys, salesforce ou produtividade)"""
    nome_lower = nome_arquivo.lower()
    
    if sistema == "genesys":
        if 'voz' in nome_lower and 'hc' in nome_lower:
            return PLANILHAS_CONFIG["genesys"]["deteccao"]["voz_hc"]
        elif 'texto' in nome_lower and 'hc' in nome_lower:
            return PLANILHAS_CONFIG["genesys"]["deteccao"]["texto_hc"]
        elif 'gest√£o' in nome_lower or 'gestao' in nome_lower:
            if 'n1' in nome_lower or 'entrega' in nome_lower:
                return PLANILHAS_CONFIG["genesys"]["deteccao"]["gestao_n1"]
            else:
                return PLANILHAS_CONFIG["genesys"]["deteccao"]["gestao"]
        elif 'fila' in nome_lower and 'todas' in nome_lower:
            # Arquivo de filas deve ir para Power BI, n√£o para o boletim
            print(f"‚ö†Ô∏è  ATEN√á√ÉO: Arquivo '{nome_arquivo}' √© de FILAS GENESYS")
            print("üéØ Este arquivo deve ser processado pela interface Power BI, n√£o pelo Pulso Boletim")
            print("üí° Use a interface Power BI para processar dados de filas")
            return None, None  # N√£o processar na interface do boletim
        elif 'fila' in nome_lower:
            return PLANILHAS_CONFIG["genesys"]["deteccao"]["fila"]
    
    elif sistema == "salesforce":
        if 'criado' in nome_lower or 'created' in nome_lower:
            return PLANILHAS_CONFIG["salesforce"]["deteccao"]["criado"]
        elif 'resolvido' in nome_lower or 'resolved' in nome_lower:
            return PLANILHAS_CONFIG["salesforce"]["deteccao"]["resolvido"]
        elif 'comentario' in nome_lower or 'comment' in nome_lower or 'bko' in nome_lower:
            return PLANILHAS_CONFIG["salesforce"]["deteccao"]["comentario_bko"]
        elif 'seller' in nome_lower or 'vendedor' in nome_lower:
            return PLANILHAS_CONFIG["salesforce"]["deteccao"]["seller"]
    
    elif sistema == "produtividade":
        if 'tempo' in nome_lower:
            return PLANILHAS_CONFIG["produtividade"]["deteccao"]["tempo"]
        elif 'produtiv' in nome_lower or 'visao' in nome_lower or 'vis√£o' in nome_lower:
            return PLANILHAS_CONFIG["produtividade"]["deteccao"]["produtividade"]
    
    return None, None

def buscar_arquivos_csv():
    """Busca todos os arquivos CSV na pasta data"""
    data_dir = os.path.join(current_dir, 'data')
    arquivos_csv = []
    
    if os.path.exists(data_dir):
        for arquivo in os.listdir(data_dir):
            if arquivo.lower().endswith('.csv'):
                arquivos_csv.append(arquivo)
    
    return arquivos_csv, data_dir

def processar_sistema(sistema_nome, executar_sistema=True):
    """Processa um sistema espec√≠fico (genesys, salesforce ou produtividade)"""
    if not executar_sistema:
        return {"sucessos": 0, "falhas": 0, "processados": 0}
    
    print(f"\n{'='*70}")
    print(f"üéØ PROCESSANDO SISTEMA: {PLANILHAS_CONFIG[sistema_nome]['nome']}")
    print(f"{'='*70}")
    
    # Configurar para a planilha espec√≠fica
    id_planilha = PLANILHAS_CONFIG[sistema_nome]["id"]
    sheets = GoogleSheetsBase(id_planilha=id_planilha)
    
    print(f"üìä ID da Planilha: {id_planilha}")
    print(f"üîó Conectando...")
    
    try:
        client = sheets.client
        planilha = client.open_by_key(id_planilha)
        print(f"‚úÖ Planilha: '{planilha.title}'")
        
        # Listar abas dispon√≠veis
        abas_disponiveis = [aba.title for aba in planilha.worksheets()]
        print(f"üìë Abas dispon√≠veis: {len(abas_disponiveis)} abas")
        
        # Buscar arquivos
        arquivos_csv, data_dir = buscar_arquivos_csv()
        
        # Verificar se h√° arquivos de filas que n√£o devem ser processados aqui
        arquivos_filas = [arq for arq in arquivos_csv if 'fila' in arq.lower() and 'todas' in arq.lower()]
        if arquivos_filas:
            print(f"‚ö†Ô∏è  AVISO: Encontrados {len(arquivos_filas)} arquivo(s) de FILAS GENESYS:")
            for arq in arquivos_filas:
                print(f"   üìÑ {arq}")
            print("üéØ Estes arquivos devem ser processados pela interface POWER BI, n√£o pelo Pulso Boletim")
            print("üí° Execute: python interface_powerbi.py")
            print("-" * 70)
        
        # Filtrar arquivos para este sistema
        arquivos_sistema = []
        for arquivo in arquivos_csv:
            aba_destino, tipo_detectado = detectar_tipo_arquivo(arquivo, sistema_nome)
            if aba_destino and aba_destino in abas_disponiveis:
                arquivos_sistema.append((arquivo, aba_destino, tipo_detectado))
            elif 'fila' in arquivo.lower() and 'todas' in arquivo.lower():
                # Arquivo de filas - mostrar aviso espec√≠fico
                print(f"‚ö†Ô∏è  IGNORADO: {arquivo} (arquivo de filas - use interface Power BI)")
        
        print(f"üìÅ Arquivos {sistema_nome.upper()} v√°lidos: {len(arquivos_sistema)}")
        
        if not arquivos_sistema:
            if arquivos_filas:
                print(f"üí° Use a interface Power BI para processar os arquivos de filas encontrados")
            else:
                print(f"‚ö†Ô∏è  Nenhum arquivo {sistema_nome.upper()} encontrado")
            return {"sucessos": 0, "falhas": 0, "processados": 0}
        
        # Processar cada arquivo
        sucessos = 0
        falhas = 0
        
        for arquivo, aba_destino, tipo_detectado in arquivos_sistema:
            print(f"\nüì§ Processando: {arquivo}")
            print(f"üéØ Tipo: {tipo_detectado}")
            print(f"üìù Destino: {aba_destino}")
            
            # Verificar dados existentes
            aba = planilha.worksheet(aba_destino)
            valores_existentes = aba.get_all_values()
            linhas_com_dados = sum(1 for linha in valores_existentes if any(cell.strip() for cell in linha))
            print(f"üìä Dados existentes: {linhas_com_dados:,} linhas")
            
            # Processar arquivo
            resultado = sheets.enviar_csv_para_planilha(arquivo, aba_destino)
            
            if resultado:
                print(f"‚úÖ SUCESSO: {arquivo} ‚Üí {aba_destino}")
                sucessos += 1
            else:
                print(f"‚ùå FALHA: {arquivo} ‚Üí {aba_destino}")
                falhas += 1
            
            print("-" * 50)
        
        return {"sucessos": sucessos, "falhas": falhas, "processados": sucessos + falhas}
        
    except Exception as e:
        print(f"‚ùå ERRO no sistema {sistema_nome.upper()}: {e}")
        return {"sucessos": 0, "falhas": 1, "processados": 1}

def main():
    """Fun√ß√£o principal"""
    
    # Configurar argumentos de linha de comando
    parser = argparse.ArgumentParser(
        description='üöÄ Automa√ß√£o Principal Leroy Merlin',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemplos:
  python main.py                    # Executa Genesys + Salesforce + Produtividade
  python main.py --genesys          # S√≥ Genesys
  python main.py --salesforce       # S√≥ Salesforce
  python main.py --produtividade    # S√≥ Produtividade
  python main.py --dados ./csvs     # Especifica pasta de dados
        """
    )
    
    parser.add_argument('--genesys', action='store_true', 
                       help='Processar apenas sistema Genesys')
    parser.add_argument('--salesforce', action='store_true',
                       help='Processar apenas sistema Salesforce')
    parser.add_argument('--produtividade', action='store_true',
                       help='Processar apenas sistema Produtividade')
    parser.add_argument('--dados', type=str, 
                       help='Pasta onde est√£o os arquivos CSV')
    parser.add_argument('--verbose', '-v', action='store_true',
                       help='Modo detalhado')
    
    args = parser.parse_args()
    
    # Header principal
    timestamp = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
    print("üöÄ AUTOMA√á√ÉO PRINCIPAL LEROY MERLIN")
    print("=" * 80)
    print(f"‚è∞ Iniciado em: {timestamp}")
    print("üîß Modo: COMPLEMENTAR (preserva dados existentes)")
    print("üé® Primeira linha: VERDE LEROY MERLIN")
    print("üìã Cabe√ßalho: REMOVIDO automaticamente")
    
    # Determinar quais sistemas executar
    executar_genesys = True
    executar_salesforce = True
    executar_produtividade = True
    
    # L√≥gica para sistemas espec√≠ficos
    sistemas_selecionados = []
    if args.genesys:
        sistemas_selecionados.append("genesys")
    if args.salesforce:
        sistemas_selecionados.append("salesforce")
    if args.produtividade:
        sistemas_selecionados.append("produtividade")
    
    # Se algum sistema foi especificamente selecionado, executar apenas eles
    if sistemas_selecionados:
        executar_genesys = "genesys" in sistemas_selecionados
        executar_salesforce = "salesforce" in sistemas_selecionados
        executar_produtividade = "produtividade" in sistemas_selecionados
        sistemas_texto = " + ".join([s.upper() for s in sistemas_selecionados])
        print(f"üéØ Executando apenas: {sistemas_texto}")
    else:
        print("üéØ Executando: GENESYS + SALESFORCE + PRODUTIVIDADE")
    
    # Verificar arquivos dispon√≠veis
    arquivos_csv, data_dir = buscar_arquivos_csv()
    print(f"üìÅ Pasta de dados: {data_dir}")
    print(f"üìÑ Arquivos CSV encontrados: {len(arquivos_csv)}")
    
    if not arquivos_csv:
        print(f"‚ùå Nenhum arquivo CSV encontrado em: {data_dir}")
        print("üí° Adicione arquivos CSV na pasta data/ e execute novamente")
        return
    
    # Executar processamentos
    inicio_processamento = datetime.now()
    
    resultado_genesys = processar_sistema("genesys", executar_genesys)
    resultado_salesforce = processar_sistema("salesforce", executar_salesforce)
    resultado_produtividade = processar_sistema("produtividade", executar_produtividade)
    
    fim_processamento = datetime.now()
    duracao = fim_processamento - inicio_processamento
    
    # Relat√≥rio final consolidado
    print(f"\n{'='*80}")
    print("üéâ RELAT√ìRIO FINAL CONSOLIDADO")
    print(f"{'='*80}")
    print(f"‚è±Ô∏è  Tempo total: {duracao}")
    print(f"üìä Processamento iniciado: {inicio_processamento.strftime('%H:%M:%S')}")
    print(f"üèÅ Processamento conclu√≠do: {fim_processamento.strftime('%H:%M:%S')}")
    print()
    
    # Estat√≠sticas por sistema
    total_sucessos = resultado_genesys["sucessos"] + resultado_salesforce["sucessos"] + resultado_produtividade["sucessos"]
    total_falhas = resultado_genesys["falhas"] + resultado_salesforce["falhas"] + resultado_produtividade["falhas"]
    total_processados = resultado_genesys["processados"] + resultado_salesforce["processados"] + resultado_produtividade["processados"]
    
    if executar_genesys:
        print(f"üìä GENESYS:")
        print(f"   ‚úÖ Sucessos: {resultado_genesys['sucessos']}")
        print(f"   ‚ùå Falhas: {resultado_genesys['falhas']}")
        print(f"   üìä Total: {resultado_genesys['processados']}")
    
    if executar_salesforce:
        print(f"üíº SALESFORCE:")
        print(f"   ‚úÖ Sucessos: {resultado_salesforce['sucessos']}")
        print(f"   ‚ùå Falhas: {resultado_salesforce['falhas']}")
        print(f"   üìä Total: {resultado_salesforce['processados']}")
    
    if executar_produtividade:
        print(f"üìà PRODUTIVIDADE:")
        print(f"   ‚úÖ Sucessos: {resultado_produtividade['sucessos']}")
        print(f"   ‚ùå Falhas: {resultado_produtividade['falhas']}")
        print(f"   üìä Total: {resultado_produtividade['processados']}")
    
    print(f"\nüéØ TOTAIS GERAIS:")
    print(f"   ‚úÖ Total de sucessos: {total_sucessos}")
    print(f"   ‚ùå Total de falhas: {total_falhas}")
    print(f"   üìä Total processado: {total_processados}")
    
    # Taxa de sucesso
    if total_processados > 0:
        taxa_sucesso = (total_sucessos / total_processados) * 100
        print(f"   üìà Taxa de sucesso: {taxa_sucesso:.1f}%")
    
    # Links para as planilhas
    if total_sucessos > 0:
        print(f"\nüîó ACESSE AS PLANILHAS ATUALIZADAS:")
        if executar_genesys and resultado_genesys["sucessos"] > 0:
            print(f"   üìä Genesys: https://docs.google.com/spreadsheets/d/{PLANILHAS_CONFIG['genesys']['id']}")
        if executar_salesforce and resultado_salesforce["sucessos"] > 0:
            print(f"   üíº Salesforce: https://docs.google.com/spreadsheets/d/{PLANILHAS_CONFIG['salesforce']['id']}")
    
    print(f"\n‚ú® Automa√ß√£o conclu√≠da! Primeira linha de cada inser√ß√£o est√° pintada de VERDE LEROY MERLIN üü¢")
    print("=" * 80)

if __name__ == "__main__":
    main()